#Quantitative Asset Management
#Final Project
#Nikhil Gupta; Morris Moussa; Rohan Rambhia; Arpit Tanna
#Cohort 4

library(DataAnalytics)
library(moments)
library(tidyr)
library(dplyr)
library(quantmod)
library(lubridate)
library(stringr)
library(data.table)
library(zoo)
library(pracma)
library(ggplot2)
library(purrr)
library(broom)
library(lmtest)
library(sandwich)


#################################################################################
#################################################################################

################  In-Sample Analysis (Replicating the Strategy)  ################
#############################  1968 - 2005  #####################################

#################################################################################
#################################################################################


#Read Required File
CRSP_Monthly_A <- fread("/Users/arpittanna/Desktop/MFE/Quarter 3/Quant Asset Management/Assignments/Project/A.csv", stringsAsFactors = FALSE, header = TRUE)
FF_Monthly <- fread("/Users/arpittanna/Desktop/MFE/Quarter 3/Quant Asset Management/Assignments/1/F-F_Research_Data_Factors.csv", stringsAsFactors = FALSE, skip = 3)

#Formatting the Date
CRSP_Monthly_A <- CRSP_Monthly_A[, date := as.Date(as.character(date), format = "%m/%d/%Y")]

#Keeping only Required Exchange Codes
CRSP_Monthly_A <- CRSP_Monthly_A[EXCHCD %in% c(1,2,3)]

#Setting Garbage Values to NA
CRSP_Monthly_A$RET[CRSP_Monthly_A$RET %in% c("C","B",-66,-77,-88,-99)] <- NA
CRSP_Monthly_A$DLRET[CRSP_Monthly_A$DLRET %in% c(-44,-55,-66,-77,-88,-99,"A","S","P","T")] <- NA

#Calculating Total Return
CRSP_Monthly_A <- CRSP_Monthly_A[, Stock_Return := ifelse(!is.na(as.numeric(CRSP_Monthly_A$RET)) & !is.na(as.numeric(CRSP_Monthly_A$DLRET)), (1+as.numeric(CRSP_Monthly_A$RET) * (1+as.numeric(CRSP_Monthly_A$DLRET))-1), ifelse(is.na(as.numeric(CRSP_Monthly_A$RET)), as.numeric(CRSP_Monthly_A$DLRET), as.numeric(CRSP_Monthly_A$RET)))]

#Calculating Market Cap
CRSP_Monthly_A <- CRSP_Monthly_A[, Stock_Market_Cap := abs(as.numeric(CRSP_Monthly_A$PRC)) * as.numeric(CRSP_Monthly_A$SHROUT)]
CRSP_Monthly_A <- CRSP_Monthly_A[, Stock_Market_Cap_Lag := shift(Stock_Market_Cap), by=c("PERMNO")]

#Isolating Month & Year
CRSP_Monthly_A <- CRSP_Monthly_A[,c('Month','Year') := .(month(date),year(date))]

#Calculating 5 Year Volatility from Monthly Data
CRSP_Monthly_A[, VOL5 := (rollapply(shift(RET), width = 60, fill = NA, align = "right", sd, partial = TRUE)), by = .(PERMNO)]
CRSP_Monthly_A <- setDT(CRSP_Monthly_A)[, if(.N >= 61) .SD, by = PERMNO]
CRSP_Monthly_A <- CRSP_Monthly_A %>% group_by(PERMNO) %>% slice(-1:-60)
CRSP_Monthly_A <- as.data.table(CRSP_Monthly_A)

#Calculating Quintile for Volatility
GetPortNums_Volatility <- function(x,y)
{
  Quintile <- c(0, quantile(y, probs = seq(0,1,0.2), na.rm = TRUE)[2:5], 1)
  return(as.integer(cut(y, Quintile, na.rm = TRUE), include.lowest = TRUE))
}

#Calculating Lag Volatility
CRSP_Monthly_A <- CRSP_Monthly_A[, Volatility_Lag := shift(VOL5), by=c("PERMNO")]

#Calculating the Quintiles
CRSP_Monthly_A <- CRSP_Monthly_A[, Volatility_Quintile := (GetPortNums_Volatility(EXCHCD, Volatility_Lag)), by=.(Year, Month)]

#Calculating Value Weighted Return
CRSP_Monthly_A[, Value_Weighted_Return := sum(Stock_Market_Cap_Lag*as.numeric(RET), na.rm = TRUE)/sum(Stock_Market_Cap_Lag, na.rm = TRUE), by=c("Year", "Month", "Volatility_Quintile")]

#Removing all NAs
CRSP_Monthly_A <- CRSP_Monthly_A[!is.na(Stock_Market_Cap_Lag) & !is.na(Value_Weighted_Return) & !is.na(Volatility_Quintile) & !is.na(RET)]

#Order the Data Table by Year, Month, and Volatility Quintile
CRSP_Monthly_A <- CRSP_Monthly_A[order(Year, Month, Volatility_Quintile)]

#Removing Duplicate Value Weighted Returns
CRSP_Monthly_A_Unique <- CRSP_Monthly_A[!duplicated(Value_Weighted_Return)]

#Calculating Portfolio Mean
Mean_Quintile_A1 <- mean(CRSP_Monthly_A_Unique$Value_Weighted_Return[CRSP_Monthly_A_Unique$Volatility_Quintile == 1])*100
Mean_Quintile_A2 <- mean(CRSP_Monthly_A_Unique$Value_Weighted_Return[CRSP_Monthly_A_Unique$Volatility_Quintile == 2])*100
Mean_Quintile_A3 <- mean(CRSP_Monthly_A_Unique$Value_Weighted_Return[CRSP_Monthly_A_Unique$Volatility_Quintile == 3])*100
Mean_Quintile_A4 <- mean(CRSP_Monthly_A_Unique$Value_Weighted_Return[CRSP_Monthly_A_Unique$Volatility_Quintile == 4])*100
Mean_Quintile_A5 <- mean(CRSP_Monthly_A_Unique$Value_Weighted_Return[CRSP_Monthly_A_Unique$Volatility_Quintile == 5])*100

#Calculating Portfolio Standard Deviation
Std_Dev_Quintile_A1 <- sd(CRSP_Monthly_A_Unique$Value_Weighted_Return[CRSP_Monthly_A_Unique$Volatility_Quintile == 1])*100
Std_Dev_Quintile_A2 <- sd(CRSP_Monthly_A_Unique$Value_Weighted_Return[CRSP_Monthly_A_Unique$Volatility_Quintile == 2])*100
Std_Dev_Quintile_A3 <- sd(CRSP_Monthly_A_Unique$Value_Weighted_Return[CRSP_Monthly_A_Unique$Volatility_Quintile == 3])*100
Std_Dev_Quintile_A4 <- sd(CRSP_Monthly_A_Unique$Value_Weighted_Return[CRSP_Monthly_A_Unique$Volatility_Quintile == 4])*100
Std_Dev_Quintile_A5 <- sd(CRSP_Monthly_A_Unique$Value_Weighted_Return[CRSP_Monthly_A_Unique$Volatility_Quintile == 5])*100

#Calculating Portfolio Sharpe Ratio
SR_1 <- mean(CRSP_Monthly_A_Unique$Value_Weighted_Return[CRSP_Monthly_A_Unique$Volatility_Quintile == 1] - FF_Monthly$RF[500:954]/100)/sd(CRSP_Monthly_A_Unique$Value_Weighted_Return[CRSP_Monthly_A_Unique$Volatility_Quintile == 1] - FF_Monthly$RF[500:954]/100)
SR_2 <- mean(CRSP_Monthly_A_Unique$Value_Weighted_Return[CRSP_Monthly_A_Unique$Volatility_Quintile == 2] - FF_Monthly$RF[500:954]/100)/sd(CRSP_Monthly_A_Unique$Value_Weighted_Return[CRSP_Monthly_A_Unique$Volatility_Quintile == 2] - FF_Monthly$RF[500:954]/100)
SR_3 <- mean(CRSP_Monthly_A_Unique$Value_Weighted_Return[CRSP_Monthly_A_Unique$Volatility_Quintile == 3] - FF_Monthly$RF[500:954]/100)/sd(CRSP_Monthly_A_Unique$Value_Weighted_Return[CRSP_Monthly_A_Unique$Volatility_Quintile == 3] - FF_Monthly$RF[500:954]/100)
SR_4 <- mean(CRSP_Monthly_A_Unique$Value_Weighted_Return[CRSP_Monthly_A_Unique$Volatility_Quintile == 4] - FF_Monthly$RF[500:954]/100)/sd(CRSP_Monthly_A_Unique$Value_Weighted_Return[CRSP_Monthly_A_Unique$Volatility_Quintile == 4] - FF_Monthly$RF[500:954]/100)
SR_5 <- mean(CRSP_Monthly_A_Unique$Value_Weighted_Return[CRSP_Monthly_A_Unique$Volatility_Quintile == 5] - FF_Monthly$RF[500:954]/100)/sd(CRSP_Monthly_A_Unique$Value_Weighted_Return[CRSP_Monthly_A_Unique$Volatility_Quintile == 5] - FF_Monthly$RF[500:954]/100)

#CAPM Alpha and T-Stat
CRSP_Monthly_A_Unique[, Market_Excess_Return := FF_Monthly$`Mkt-RF`[500:954]/100, by=.(Volatility_Quintile)]
CRSP_Monthly_A_Unique[, Value_Weighted_Excess_Return := Value_Weighted_Return - FF_Monthly$RF[500:954]/100, by=.(Volatility_Quintile)]
CRSP_Monthly_A_Unique[, CAPM_Alpha := as.list(coef(lm(Value_Weighted_Excess_Return ~ Market_Excess_Return))), by=.(Volatility_Quintile)]
CRSP_Monthly_A_Unique[, CAPM_Alpha_T_Test := coeftest((lm(Value_Weighted_Excess_Return ~ Market_Excess_Return)), vcov = NeweyWest((lm(Value_Weighted_Excess_Return ~ Market_Excess_Return)), lag = 1, prewhite = FALSE))[1,3], by=.(Volatility_Quintile)]

#FF Alpha and T-Stat
CRSP_Monthly_A_Unique[, HML := FF_Monthly$HML[500:954]/100, by=.(Volatility_Quintile)]
CRSP_Monthly_A_Unique[, SMB := FF_Monthly$SMB[500:954]/100, by=.(Volatility_Quintile)]
CRSP_Monthly_A_Unique[, FF_Alpha := coeftest((lm(Value_Weighted_Excess_Return ~ (HML + SMB + Market_Excess_Return))), vcov = NeweyWest((lm(Value_Weighted_Excess_Return ~ (HML + SMB + Market_Excess_Return))), lag = 1, prewhite = FALSE))[1,1], by=.(Volatility_Quintile)]
CRSP_Monthly_A_Unique[, FF_Alpha_T_Test := coeftest((lm(Value_Weighted_Excess_Return ~ (HML + SMB + Market_Excess_Return))), vcov = NeweyWest((lm(Value_Weighted_Excess_Return ~ (HML + SMB + Market_Excess_Return))), lag = 1, prewhite = FALSE))[1,3], by=.(Volatility_Quintile)]
CRSP_Monthly_A_Unique[, FF_Beta_HML := coeftest((lm(Value_Weighted_Excess_Return ~ (HML + SMB + Market_Excess_Return))), vcov = NeweyWest((lm(Value_Weighted_Excess_Return ~ (HML + SMB + Market_Excess_Return))), lag = 1, prewhite = FALSE))[2,1], by=.(Volatility_Quintile)]
CRSP_Monthly_A_Unique[, FF_Beta_SMB := coeftest((lm(Value_Weighted_Excess_Return ~ (HML + SMB + Market_Excess_Return))), vcov = NeweyWest((lm(Value_Weighted_Excess_Return ~ (HML + SMB + Market_Excess_Return))), lag = 1, prewhite = FALSE))[3,1], by=.(Volatility_Quintile)]
CRSP_Monthly_A_Unique[, FF_Beta_Market := coeftest((lm(Value_Weighted_Excess_Return ~ (HML + SMB + Market_Excess_Return))), vcov = NeweyWest((lm(Value_Weighted_Excess_Return ~ (HML + SMB + Market_Excess_Return))), lag = 1, prewhite = FALSE))[4,1], by=.(Volatility_Quintile)]
CRSP_Monthly_A_Unique[, FF_HML_T_Test := coeftest((lm(Value_Weighted_Excess_Return ~ (HML + SMB + Market_Excess_Return))), vcov = NeweyWest((lm(Value_Weighted_Excess_Return ~ (HML + SMB + Market_Excess_Return))), lag = 1, prewhite = FALSE))[2,3], by=.(Volatility_Quintile)]
CRSP_Monthly_A_Unique[, FF_SMB_T_Test := coeftest((lm(Value_Weighted_Excess_Return ~ (HML + SMB + Market_Excess_Return))), vcov = NeweyWest((lm(Value_Weighted_Excess_Return ~ (HML + SMB + Market_Excess_Return))), lag = 1, prewhite = FALSE))[3,3], by=.(Volatility_Quintile)]
CRSP_Monthly_A_Unique[, FF_Market_T_Test := coeftest((lm(Value_Weighted_Excess_Return ~ (HML + SMB + Market_Excess_Return))), vcov = NeweyWest((lm(Value_Weighted_Excess_Return ~ (HML + SMB + Market_Excess_Return))), lag = 1, prewhite = FALSE))[4,3], by=.(Volatility_Quintile)]

#Long Short
Mean_Long_Short_A <- Mean_Quintile_A1 - Mean_Quintile_A5
Std_Dev_Long_Short_A <- sd(CRSP_Monthly_A_Unique$Value_Weighted_Return[CRSP_Monthly_A_Unique$Volatility_Quintile == 1] - CRSP_Monthly_A_Unique$Value_Weighted_Return[CRSP_Monthly_A_Unique$Volatility_Quintile == 5])*100
SR_Long_Short <- mean(((CRSP_Monthly_A_Unique$Value_Weighted_Return[CRSP_Monthly_A_Unique$Volatility_Quintile == 1] - FF_Monthly$RF[500:954]/100) - (CRSP_Monthly_A_Unique$Value_Weighted_Return[CRSP_Monthly_A_Unique$Volatility_Quintile == 5] - FF_Monthly$RF[500:954]/100))/sd(((CRSP_Monthly_A_Unique$Value_Weighted_Return[CRSP_Monthly_A_Unique$Volatility_Quintile == 1] - FF_Monthly$RF[500:954]/100) - (CRSP_Monthly_A_Unique$Value_Weighted_Return[CRSP_Monthly_A_Unique$Volatility_Quintile == 5] - FF_Monthly$RF[500:954]/100))))

ABC <- FF_Monthly$`Mkt-RF`[500:954]/100
XYZ <- (CRSP_Monthly_A_Unique$Value_Weighted_Return[CRSP_Monthly_A_Unique$Volatility_Quintile == 1] - CRSP_Monthly_A_Unique$Value_Weighted_Return[CRSP_Monthly_A_Unique$Volatility_Quintile == 5])

CAPM_Alpha_LS_A <- as.numeric(coef(lm(XYZ ~ ABC))[1])*100
CAPM_Alpha_T_Stat_LS_A <- coeftest((lm(XYZ ~ ABC)), vcov = NeweyWest((lm(XYZ ~ ABC)), lag = 1, prewhite = FALSE))[1,3]

FF_Alpha_LS <- coeftest((lm(XYZ ~ (CRSP_Monthly_A_Unique$HML[CRSP_Monthly_A_Unique$Volatility_Quintile == 1] + CRSP_Monthly_A_Unique$SMB[CRSP_Monthly_A_Unique$Volatility_Quintile == 1] + ABC))), vcov = NeweyWest((lm(XYZ ~ (CRSP_Monthly_A_Unique$HML[CRSP_Monthly_A_Unique$Volatility_Quintile == 1] + CRSP_Monthly_A_Unique$SMB[CRSP_Monthly_A_Unique$Volatility_Quintile == 1] + ABC))), lag = 1, prewhite = FALSE))[1,1]*100
FF_Alpha_T_Test_LS <- coeftest((lm(XYZ ~ (CRSP_Monthly_A_Unique$HML[CRSP_Monthly_A_Unique$Volatility_Quintile == 1] + CRSP_Monthly_A_Unique$SMB[CRSP_Monthly_A_Unique$Volatility_Quintile == 1] + ABC))), vcov = NeweyWest((lm(XYZ ~ (CRSP_Monthly_A_Unique$HML[CRSP_Monthly_A_Unique$Volatility_Quintile == 1] + CRSP_Monthly_A_Unique$SMB[CRSP_Monthly_A_Unique$Volatility_Quintile == 1] + ABC))), lag = 1, prewhite = FALSE))[1,3]
FF_Beta_HML_LS <- coeftest((lm(XYZ ~ (CRSP_Monthly_A_Unique$HML[CRSP_Monthly_A_Unique$Volatility_Quintile == 1] + CRSP_Monthly_A_Unique$SMB[CRSP_Monthly_A_Unique$Volatility_Quintile == 1] + ABC))), vcov = NeweyWest((lm(XYZ ~ (CRSP_Monthly_A_Unique$HML[CRSP_Monthly_A_Unique$Volatility_Quintile == 1] + CRSP_Monthly_A_Unique$SMB[CRSP_Monthly_A_Unique$Volatility_Quintile == 1] + ABC))), lag = 1, prewhite = FALSE))[2,1]
FF_Beta_SMB_LS <- coeftest((lm(XYZ ~ (CRSP_Monthly_A_Unique$HML[CRSP_Monthly_A_Unique$Volatility_Quintile == 1] + CRSP_Monthly_A_Unique$SMB[CRSP_Monthly_A_Unique$Volatility_Quintile == 1] + ABC))), vcov = NeweyWest((lm(XYZ ~ (CRSP_Monthly_A_Unique$HML[CRSP_Monthly_A_Unique$Volatility_Quintile == 1] + CRSP_Monthly_A_Unique$SMB[CRSP_Monthly_A_Unique$Volatility_Quintile == 1] + ABC))), lag = 1, prewhite = FALSE))[3,1]
FF_Beta_Market_LS <- coeftest((lm(XYZ ~ (CRSP_Monthly_A_Unique$HML[CRSP_Monthly_A_Unique$Volatility_Quintile == 1] + CRSP_Monthly_A_Unique$SMB[CRSP_Monthly_A_Unique$Volatility_Quintile == 1] + ABC))), vcov = NeweyWest((lm(XYZ ~ (CRSP_Monthly_A_Unique$HML[CRSP_Monthly_A_Unique$Volatility_Quintile == 1] + CRSP_Monthly_A_Unique$SMB[CRSP_Monthly_A_Unique$Volatility_Quintile == 1] + ABC))), lag = 1, prewhite = FALSE))[4,1]
FF_HML_T_Test_LS <- coeftest((lm(XYZ ~ (CRSP_Monthly_A_Unique$HML[CRSP_Monthly_A_Unique$Volatility_Quintile == 1] + CRSP_Monthly_A_Unique$SMB[CRSP_Monthly_A_Unique$Volatility_Quintile == 1] + ABC))), vcov = NeweyWest((lm(XYZ ~ (CRSP_Monthly_A_Unique$HML[CRSP_Monthly_A_Unique$Volatility_Quintile == 1] + CRSP_Monthly_A_Unique$SMB[CRSP_Monthly_A_Unique$Volatility_Quintile == 1] + ABC))), lag = 1, prewhite = FALSE))[2,3]
FF_SMB_T_Test_LS <- coeftest((lm(XYZ ~ (CRSP_Monthly_A_Unique$HML[CRSP_Monthly_A_Unique$Volatility_Quintile == 1] + CRSP_Monthly_A_Unique$SMB[CRSP_Monthly_A_Unique$Volatility_Quintile == 1] + ABC))), vcov = NeweyWest((lm(XYZ ~ (CRSP_Monthly_A_Unique$HML[CRSP_Monthly_A_Unique$Volatility_Quintile == 1] + CRSP_Monthly_A_Unique$SMB[CRSP_Monthly_A_Unique$Volatility_Quintile == 1] + ABC))), lag = 1, prewhite = FALSE))[3,3]
FF_Market_T_Test_LS <- coeftest((lm(XYZ ~ (CRSP_Monthly_A_Unique$HML[CRSP_Monthly_A_Unique$Volatility_Quintile == 1] + CRSP_Monthly_A_Unique$SMB[CRSP_Monthly_A_Unique$Volatility_Quintile == 1] + ABC))), vcov = NeweyWest((lm(XYZ ~ (CRSP_Monthly_A_Unique$HML[CRSP_Monthly_A_Unique$Volatility_Quintile == 1] + CRSP_Monthly_A_Unique$SMB[CRSP_Monthly_A_Unique$Volatility_Quintile == 1] + ABC))), lag = 1, prewhite = FALSE))[4,3]

LS_Row <- rbind(Mean_Long_Short_A, Std_Dev_Long_Short_A, SR_Long_Short, CAPM_Alpha_LS_A, CAPM_Alpha_T_Stat_LS_A, FF_Alpha_LS, FF_Alpha_T_Test_LS, FF_Beta_HML_LS, FF_HML_T_Test_LS, FF_Beta_SMB_LS, FF_SMB_T_Test_LS, FF_Beta_Market_LS, FF_Market_T_Test_LS)

#Plot
Date <- as.Date(unique(CRSP_Monthly_A_Unique$date))
plot(Date, cumsum(CRSP_Monthly_A_Unique$Value_Weighted_Return[CRSP_Monthly_A_Unique$Volatility_Quintile == 1]), type = 'l', col = "dodgerblue4", lwd = 2.5, main = "Low Volatility vs. High Volatility (1968-2005)", xlab = "Time", ylab = "Aggregate Returns", ylim = c(-1,5))
lines(Date, (cumsum(CRSP_Monthly_A_Unique$Value_Weighted_Return[CRSP_Monthly_A_Unique$Volatility_Quintile == 5])), type = 'l', col = "red", lwd = 2.5)
legend("topleft", inset = c(0.02, 0.05), c("Low Volatility", "High Volatility"), lty = c(1, 1), lwd = c(2.5,2.5), cex = 0.8, col = c("dodgerblue4","red"))

#Output
Mean_Panel_A <- rbind(Mean_Quintile_A1, Mean_Quintile_A2, Mean_Quintile_A3, Mean_Quintile_A4, Mean_Quintile_A5)
Std_Dev_Panel_A <- rbind(Std_Dev_Quintile_A1, Std_Dev_Quintile_A2, Std_Dev_Quintile_A3, Std_Dev_Quintile_A4, Std_Dev_Quintile_A5)
Sharpe_Ratio_Panel_A <- rbind(SR_1, SR_2, SR_3, SR_4, SR_5)
CAPM_Alpha_Panel_A <- CRSP_Monthly_A_Unique$CAPM_Alpha[1:5]*100
CAPM_T_Test_Panel_A <- CRSP_Monthly_A_Unique$CAPM_Alpha_T_Test[1:5]
FF_Alpha_Panel_A <- CRSP_Monthly_A_Unique$FF_Alpha[1:5]*100
FF_T_Test_Panel_A <- CRSP_Monthly_A_Unique$FF_Alpha_T_Test[1:5]
FF_Beta_HML <- CRSP_Monthly_A_Unique$FF_Beta_HML[1:5]
FF_HML_T_Test <- CRSP_Monthly_A_Unique$FF_HML_T_Test[1:5]
FF_Beta_SMB <- CRSP_Monthly_A_Unique$FF_Beta_SMB[1:5]
FF_SMB_T_Test <- CRSP_Monthly_A_Unique$FF_SMB_T_Test[1:5]
FF_Beta_Market <- CRSP_Monthly_A_Unique$FF_Beta_Market[1:5]
FF_Market_T_Test <- CRSP_Monthly_A_Unique$FF_Market_T_Test[1:5]

Output_Panel_A <- cbind(Mean_Panel_A, Std_Dev_Panel_A, Sharpe_Ratio_Panel_A, cbind(CAPM_Alpha_Panel_A, CAPM_T_Test_Panel_A, FF_Alpha_Panel_A, FF_T_Test_Panel_A, FF_Beta_HML, FF_HML_T_Test, FF_Beta_SMB, FF_SMB_T_Test, FF_Beta_Market, FF_Market_T_Test))
Output_Panel_A <- rbind(Output_Panel_A, LS_Row[,1])
colnames(Output_Panel_A) <- c("Mean","Std Dev", "Sharpe Ratio", "CAPM Alpha", "CAPM Alpha T-Stat", "FF Alpha", "FF Alpha T-Stat", "FF Beta (HML)", "FF Beta (HML) T-Stat", "FF Beta (SMB)", "FF Beta (SMB) T-Stat", "FF Beta (Mkt)", "FF Beta (Mkt) T-Stat")
rownames(Output_Panel_A) <- c("1","2","3","4","5","Long Short")
A_Output <- round(Output_Panel_A,2)


#################################################################################
#################################################################################

####################  Out of Sample Analysis for Robustness  ####################
#############################  2006 - 2012  #####################################

#################################################################################
#################################################################################


#Read Required File
CRSP_Monthly_B <- fread("/Users/arpittanna/Desktop/MFE/Quarter 3/Quant Asset Management/Assignments/Project/B.csv", stringsAsFactors = FALSE, header = TRUE)
FF_Monthly <- fread("/Users/arpittanna/Desktop/MFE/Quarter 3/Quant Asset Management/Assignments/1/F-F_Research_Data_Factors.csv", stringsAsFactors = FALSE, skip = 3)

#Formatting the Date
CRSP_Monthly_B <- CRSP_Monthly_B[, date := as.Date(as.character(date), format = "%m/%d/%Y")]

#Keeping only Required Exchange Codes
CRSP_Monthly_B <- CRSP_Monthly_B[EXCHCD %in% c(1,2,3)]

#Setting Garbage Values to NA
CRSP_Monthly_B$RET[CRSP_Monthly_B$RET %in% c("C","B",-66,-77,-88,-99)] <- NA
CRSP_Monthly_B$DLRET[CRSP_Monthly_B$DLRET %in% c(-44,-55,-66,-77,-88,-99,"A","S","P","T")] <- NA

#Calculating Total Return
CRSP_Monthly_B <- CRSP_Monthly_B[, Stock_Return := ifelse(!is.na(as.numeric(CRSP_Monthly_B$RET)) & !is.na(as.numeric(CRSP_Monthly_B$DLRET)), (1+as.numeric(CRSP_Monthly_B$RET) * (1+as.numeric(CRSP_Monthly_B$DLRET))-1), ifelse(is.na(as.numeric(CRSP_Monthly_B$RET)), as.numeric(CRSP_Monthly_B$DLRET), as.numeric(CRSP_Monthly_B$RET)))]

#Calculating Market Cap
CRSP_Monthly_B <- CRSP_Monthly_B[, Stock_Market_Cap := abs(as.numeric(CRSP_Monthly_B$PRC)) * as.numeric(CRSP_Monthly_B$SHROUT)]
CRSP_Monthly_B <- CRSP_Monthly_B[, Stock_Market_Cap_Lag := shift(Stock_Market_Cap), by=c("PERMNO")]

#Isolating Month & Year
CRSP_Monthly_B <- CRSP_Monthly_B[,c('Month','Year') := .(month(date),year(date))]

#Calculating 5 Year Volatility from Monthly Data
CRSP_Monthly_B[, VOL5 := (rollapply(shift(RET), width = 60, fill = NA, align = "right", sd, partial = TRUE)), by = .(PERMNO)]
CRSP_Monthly_B <- setDT(CRSP_Monthly_B)[, if(.N >= 61) .SD, by = PERMNO]
CRSP_Monthly_B <- CRSP_Monthly_B %>% group_by(PERMNO) %>% slice(-1:-60)
CRSP_Monthly_B <- as.data.table(CRSP_Monthly_B)

#Calculating Quintile for Volatility
GetPortNums_Volatility <- function(x,y)
{
  Quintile <- c(0, quantile(y, probs = seq(0,1,0.2), na.rm = TRUE)[2:5], 1)
  return(as.integer(cut(y, Quintile, na.rm = TRUE), include.lowest = TRUE))
}

#Calculating Lag Volatility
CRSP_Monthly_B <- CRSP_Monthly_B[, Volatility_Lag := shift(VOL5), by=c("PERMNO")]

#Calculating the Quintiles
CRSP_Monthly_B <- CRSP_Monthly_B[, Volatility_Quintile := (GetPortNums_Volatility(EXCHCD, Volatility_Lag)), by=.(Year, Month)]

#Calculating Value Weighted Return
CRSP_Monthly_B[, Value_Weighted_Return := sum(Stock_Market_Cap_Lag*as.numeric(RET), na.rm = TRUE)/sum(Stock_Market_Cap_Lag, na.rm = TRUE), by=c("Year", "Month", "Volatility_Quintile")]

#Removing all NAs
CRSP_Monthly_B <- CRSP_Monthly_B[!is.na(Stock_Market_Cap_Lag) & !is.na(Value_Weighted_Return) & !is.na(Volatility_Quintile) & !is.na(RET)]

#Order the Data Table by Year, Month, and Volatility Quintile
CRSP_Monthly_B <- CRSP_Monthly_B[order(Year, Month, Volatility_Quintile)]

#Removing Duplicate Value Weighted Returns
CRSP_Monthly_B_Unique <- CRSP_Monthly_B[!duplicated(Value_Weighted_Return)]

#Calculating Portfolio Mean
Mean_Quintile_B1 <- mean(CRSP_Monthly_B_Unique$Value_Weighted_Return[CRSP_Monthly_B_Unique$Volatility_Quintile == 1])*100
Mean_Quintile_B2 <- mean(CRSP_Monthly_B_Unique$Value_Weighted_Return[CRSP_Monthly_B_Unique$Volatility_Quintile == 2])*100
Mean_Quintile_B3 <- mean(CRSP_Monthly_B_Unique$Value_Weighted_Return[CRSP_Monthly_B_Unique$Volatility_Quintile == 3])*100
Mean_Quintile_B4 <- mean(CRSP_Monthly_B_Unique$Value_Weighted_Return[CRSP_Monthly_B_Unique$Volatility_Quintile == 4])*100
Mean_Quintile_B5 <- mean(CRSP_Monthly_B_Unique$Value_Weighted_Return[CRSP_Monthly_B_Unique$Volatility_Quintile == 5])*100

#Calculating Portfolio Standard Deviation
Std_Dev_Quintile_B1 <- sd(CRSP_Monthly_B_Unique$Value_Weighted_Return[CRSP_Monthly_B_Unique$Volatility_Quintile == 1])*100
Std_Dev_Quintile_B2 <- sd(CRSP_Monthly_B_Unique$Value_Weighted_Return[CRSP_Monthly_B_Unique$Volatility_Quintile == 2])*100
Std_Dev_Quintile_B3 <- sd(CRSP_Monthly_B_Unique$Value_Weighted_Return[CRSP_Monthly_B_Unique$Volatility_Quintile == 3])*100
Std_Dev_Quintile_B4 <- sd(CRSP_Monthly_B_Unique$Value_Weighted_Return[CRSP_Monthly_B_Unique$Volatility_Quintile == 4])*100
Std_Dev_Quintile_B5 <- sd(CRSP_Monthly_B_Unique$Value_Weighted_Return[CRSP_Monthly_B_Unique$Volatility_Quintile == 5])*100

#Calculating Portfolio Sharpe Ratio
SR_1 <- mean(CRSP_Monthly_B_Unique$Value_Weighted_Return[CRSP_Monthly_B_Unique$Volatility_Quintile == 1] - FF_Monthly$RF[956:1038]/100)/sd(CRSP_Monthly_B_Unique$Value_Weighted_Return[CRSP_Monthly_B_Unique$Volatility_Quintile == 1] - FF_Monthly$RF[956:1038]/100)
SR_2 <- mean(CRSP_Monthly_B_Unique$Value_Weighted_Return[CRSP_Monthly_B_Unique$Volatility_Quintile == 2] - FF_Monthly$RF[956:1038]/100)/sd(CRSP_Monthly_B_Unique$Value_Weighted_Return[CRSP_Monthly_B_Unique$Volatility_Quintile == 2] - FF_Monthly$RF[956:1038]/100)
SR_3 <- mean(CRSP_Monthly_B_Unique$Value_Weighted_Return[CRSP_Monthly_B_Unique$Volatility_Quintile == 3] - FF_Monthly$RF[956:1038]/100)/sd(CRSP_Monthly_B_Unique$Value_Weighted_Return[CRSP_Monthly_B_Unique$Volatility_Quintile == 3] - FF_Monthly$RF[956:1038]/100)
SR_4 <- mean(CRSP_Monthly_B_Unique$Value_Weighted_Return[CRSP_Monthly_B_Unique$Volatility_Quintile == 4] - FF_Monthly$RF[956:1038]/100)/sd(CRSP_Monthly_B_Unique$Value_Weighted_Return[CRSP_Monthly_B_Unique$Volatility_Quintile == 4] - FF_Monthly$RF[956:1038]/100)
SR_5 <- mean(CRSP_Monthly_B_Unique$Value_Weighted_Return[CRSP_Monthly_B_Unique$Volatility_Quintile == 5] - FF_Monthly$RF[956:1038]/100)/sd(CRSP_Monthly_B_Unique$Value_Weighted_Return[CRSP_Monthly_B_Unique$Volatility_Quintile == 5] - FF_Monthly$RF[956:1038]/100)

#CAPM Alpha and T-Stat
CRSP_Monthly_B_Unique[, Market_Excess_Return := FF_Monthly$`Mkt-RF`[956:1038]/100, by=.(Volatility_Quintile)]
CRSP_Monthly_B_Unique[, Value_Weighted_Excess_Return := Value_Weighted_Return - FF_Monthly$RF[956:1038]/100, by=.(Volatility_Quintile)]
CRSP_Monthly_B_Unique[, CAPM_Alpha := as.list(coef(lm(Value_Weighted_Excess_Return ~ Market_Excess_Return))), by=.(Volatility_Quintile)]
CRSP_Monthly_B_Unique[, CAPM_Alpha_T_Test := coeftest((lm(Value_Weighted_Excess_Return ~ Market_Excess_Return)), vcov = NeweyWest((lm(Value_Weighted_Excess_Return ~ Market_Excess_Return)), lag = 1, prewhite = FALSE))[1,3], by=.(Volatility_Quintile)]

#FF Alpha and T-Stat
CRSP_Monthly_B_Unique[, HML := FF_Monthly$HML[956:1038]/100, by=.(Volatility_Quintile)]
CRSP_Monthly_B_Unique[, SMB := FF_Monthly$SMB[956:1038]/100, by=.(Volatility_Quintile)]
CRSP_Monthly_B_Unique[, FF_Alpha := coeftest((lm(Value_Weighted_Excess_Return ~ (HML + SMB + Market_Excess_Return))), vcov = NeweyWest((lm(Value_Weighted_Excess_Return ~ (HML + SMB + Market_Excess_Return))), lag = 1, prewhite = FALSE))[1,1], by=.(Volatility_Quintile)]
CRSP_Monthly_B_Unique[, FF_Alpha_T_Test := coeftest((lm(Value_Weighted_Excess_Return ~ (HML + SMB + Market_Excess_Return))), vcov = NeweyWest((lm(Value_Weighted_Excess_Return ~ (HML + SMB + Market_Excess_Return))), lag = 1, prewhite = FALSE))[1,3], by=.(Volatility_Quintile)]
CRSP_Monthly_B_Unique[, FF_Beta_HML := coeftest((lm(Value_Weighted_Excess_Return ~ (HML + SMB + Market_Excess_Return))), vcov = NeweyWest((lm(Value_Weighted_Excess_Return ~ (HML + SMB + Market_Excess_Return))), lag = 1, prewhite = FALSE))[2,1], by=.(Volatility_Quintile)]
CRSP_Monthly_B_Unique[, FF_Beta_SMB := coeftest((lm(Value_Weighted_Excess_Return ~ (HML + SMB + Market_Excess_Return))), vcov = NeweyWest((lm(Value_Weighted_Excess_Return ~ (HML + SMB + Market_Excess_Return))), lag = 1, prewhite = FALSE))[3,1], by=.(Volatility_Quintile)]
CRSP_Monthly_B_Unique[, FF_Beta_Market := coeftest((lm(Value_Weighted_Excess_Return ~ (HML + SMB + Market_Excess_Return))), vcov = NeweyWest((lm(Value_Weighted_Excess_Return ~ (HML + SMB + Market_Excess_Return))), lag = 1, prewhite = FALSE))[4,1], by=.(Volatility_Quintile)]
CRSP_Monthly_B_Unique[, FF_HML_T_Test := coeftest((lm(Value_Weighted_Excess_Return ~ (HML + SMB + Market_Excess_Return))), vcov = NeweyWest((lm(Value_Weighted_Excess_Return ~ (HML + SMB + Market_Excess_Return))), lag = 1, prewhite = FALSE))[2,3], by=.(Volatility_Quintile)]
CRSP_Monthly_B_Unique[, FF_SMB_T_Test := coeftest((lm(Value_Weighted_Excess_Return ~ (HML + SMB + Market_Excess_Return))), vcov = NeweyWest((lm(Value_Weighted_Excess_Return ~ (HML + SMB + Market_Excess_Return))), lag = 1, prewhite = FALSE))[3,3], by=.(Volatility_Quintile)]
CRSP_Monthly_B_Unique[, FF_Market_T_Test := coeftest((lm(Value_Weighted_Excess_Return ~ (HML + SMB + Market_Excess_Return))), vcov = NeweyWest((lm(Value_Weighted_Excess_Return ~ (HML + SMB + Market_Excess_Return))), lag = 1, prewhite = FALSE))[4,3], by=.(Volatility_Quintile)]

#Long Short
Mean_Long_Short_B <- Mean_Quintile_B1 - Mean_Quintile_B5
Std_Dev_Long_Short_B <- sd(CRSP_Monthly_B_Unique$Value_Weighted_Return[CRSP_Monthly_B_Unique$Volatility_Quintile == 1] - CRSP_Monthly_B_Unique$Value_Weighted_Return[CRSP_Monthly_B_Unique$Volatility_Quintile == 5])*100
SR_Long_Short <- mean(((CRSP_Monthly_B_Unique$Value_Weighted_Return[CRSP_Monthly_B_Unique$Volatility_Quintile == 1] - FF_Monthly$RF[956:1038]/100) - (CRSP_Monthly_B_Unique$Value_Weighted_Return[CRSP_Monthly_B_Unique$Volatility_Quintile == 5] - FF_Monthly$RF[956:1038]/100))/sd(((CRSP_Monthly_B_Unique$Value_Weighted_Return[CRSP_Monthly_B_Unique$Volatility_Quintile == 1] - FF_Monthly$RF[956:1038]/100) - (CRSP_Monthly_B_Unique$Value_Weighted_Return[CRSP_Monthly_B_Unique$Volatility_Quintile == 5] - FF_Monthly$RF[956:1038]/100))))

ABC <- FF_Monthly$`Mkt-RF`[956:1038]/100
XYZ <- (CRSP_Monthly_B_Unique$Value_Weighted_Return[CRSP_Monthly_B_Unique$Volatility_Quintile == 1] - CRSP_Monthly_B_Unique$Value_Weighted_Return[CRSP_Monthly_B_Unique$Volatility_Quintile == 5])

CAPM_Alpha_LS_B <- as.numeric(coef(lm(XYZ ~ ABC))[1])*100
CAPM_Alpha_T_Stat_LS_B <- coeftest((lm(XYZ ~ ABC)), vcov = NeweyWest((lm(XYZ ~ ABC)), lag = 1, prewhite = FALSE))[1,3]

FF_Alpha_LS <- coeftest((lm(XYZ ~ (CRSP_Monthly_B_Unique$HML[CRSP_Monthly_B_Unique$Volatility_Quintile == 1] + CRSP_Monthly_B_Unique$SMB[CRSP_Monthly_B_Unique$Volatility_Quintile == 1] + ABC))), vcov = NeweyWest((lm(XYZ ~ (CRSP_Monthly_B_Unique$HML[CRSP_Monthly_B_Unique$Volatility_Quintile == 1] + CRSP_Monthly_B_Unique$SMB[CRSP_Monthly_B_Unique$Volatility_Quintile == 1] + ABC))), lag = 1, prewhite = FALSE))[1,1]*100
FF_Alpha_T_Test_LS <- coeftest((lm(XYZ ~ (CRSP_Monthly_B_Unique$HML[CRSP_Monthly_B_Unique$Volatility_Quintile == 1] + CRSP_Monthly_B_Unique$SMB[CRSP_Monthly_B_Unique$Volatility_Quintile == 1] + ABC))), vcov = NeweyWest((lm(XYZ ~ (CRSP_Monthly_B_Unique$HML[CRSP_Monthly_B_Unique$Volatility_Quintile == 1] + CRSP_Monthly_B_Unique$SMB[CRSP_Monthly_B_Unique$Volatility_Quintile == 1] + ABC))), lag = 1, prewhite = FALSE))[1,3]
FF_Beta_HML_LS <- coeftest((lm(XYZ ~ (CRSP_Monthly_B_Unique$HML[CRSP_Monthly_B_Unique$Volatility_Quintile == 1] + CRSP_Monthly_B_Unique$SMB[CRSP_Monthly_B_Unique$Volatility_Quintile == 1] + ABC))), vcov = NeweyWest((lm(XYZ ~ (CRSP_Monthly_B_Unique$HML[CRSP_Monthly_B_Unique$Volatility_Quintile == 1] + CRSP_Monthly_B_Unique$SMB[CRSP_Monthly_B_Unique$Volatility_Quintile == 1] + ABC))), lag = 1, prewhite = FALSE))[2,1]
FF_Beta_SMB_LS <- coeftest((lm(XYZ ~ (CRSP_Monthly_B_Unique$HML[CRSP_Monthly_B_Unique$Volatility_Quintile == 1] + CRSP_Monthly_B_Unique$SMB[CRSP_Monthly_B_Unique$Volatility_Quintile == 1] + ABC))), vcov = NeweyWest((lm(XYZ ~ (CRSP_Monthly_B_Unique$HML[CRSP_Monthly_B_Unique$Volatility_Quintile == 1] + CRSP_Monthly_B_Unique$SMB[CRSP_Monthly_B_Unique$Volatility_Quintile == 1] + ABC))), lag = 1, prewhite = FALSE))[3,1]
FF_Beta_Market_LS <- coeftest((lm(XYZ ~ (CRSP_Monthly_B_Unique$HML[CRSP_Monthly_B_Unique$Volatility_Quintile == 1] + CRSP_Monthly_B_Unique$SMB[CRSP_Monthly_B_Unique$Volatility_Quintile == 1] + ABC))), vcov = NeweyWest((lm(XYZ ~ (CRSP_Monthly_B_Unique$HML[CRSP_Monthly_B_Unique$Volatility_Quintile == 1] + CRSP_Monthly_B_Unique$SMB[CRSP_Monthly_B_Unique$Volatility_Quintile == 1] + ABC))), lag = 1, prewhite = FALSE))[4,1]
FF_HML_T_Test_LS <- coeftest((lm(XYZ ~ (CRSP_Monthly_B_Unique$HML[CRSP_Monthly_B_Unique$Volatility_Quintile == 1] + CRSP_Monthly_B_Unique$SMB[CRSP_Monthly_B_Unique$Volatility_Quintile == 1] + ABC))), vcov = NeweyWest((lm(XYZ ~ (CRSP_Monthly_B_Unique$HML[CRSP_Monthly_B_Unique$Volatility_Quintile == 1] + CRSP_Monthly_B_Unique$SMB[CRSP_Monthly_B_Unique$Volatility_Quintile == 1] + ABC))), lag = 1, prewhite = FALSE))[2,3]
FF_SMB_T_Test_LS <- coeftest((lm(XYZ ~ (CRSP_Monthly_B_Unique$HML[CRSP_Monthly_B_Unique$Volatility_Quintile == 1] + CRSP_Monthly_B_Unique$SMB[CRSP_Monthly_B_Unique$Volatility_Quintile == 1] + ABC))), vcov = NeweyWest((lm(XYZ ~ (CRSP_Monthly_B_Unique$HML[CRSP_Monthly_B_Unique$Volatility_Quintile == 1] + CRSP_Monthly_B_Unique$SMB[CRSP_Monthly_B_Unique$Volatility_Quintile == 1] + ABC))), lag = 1, prewhite = FALSE))[3,3]
FF_Market_T_Test_LS <- coeftest((lm(XYZ ~ (CRSP_Monthly_B_Unique$HML[CRSP_Monthly_B_Unique$Volatility_Quintile == 1] + CRSP_Monthly_B_Unique$SMB[CRSP_Monthly_B_Unique$Volatility_Quintile == 1] + ABC))), vcov = NeweyWest((lm(XYZ ~ (CRSP_Monthly_B_Unique$HML[CRSP_Monthly_B_Unique$Volatility_Quintile == 1] + CRSP_Monthly_B_Unique$SMB[CRSP_Monthly_B_Unique$Volatility_Quintile == 1] + ABC))), lag = 1, prewhite = FALSE))[4,3]

LS_Row <- rbind(Mean_Long_Short_B, Std_Dev_Long_Short_B, SR_Long_Short, CAPM_Alpha_LS_B, CAPM_Alpha_T_Stat_LS_B, FF_Alpha_LS, FF_Alpha_T_Test_LS, FF_Beta_HML_LS, FF_HML_T_Test_LS, FF_Beta_SMB_LS, FF_SMB_T_Test_LS, FF_Beta_Market_LS, FF_Market_T_Test_LS)

#Plot
Date <- as.Date(unique(CRSP_Monthly_B_Unique$date))
plot(Date, cumsum(CRSP_Monthly_B_Unique$Value_Weighted_Return[CRSP_Monthly_B_Unique$Volatility_Quintile == 1]), type = 'l', col = "dodgerblue4", lwd = 2.5, main = "Low Volatility vs. High Volatility (2006-2012)", xlab = "Time", ylab = "Aggregate Returns", ylim = c(-1,0.5))
lines(Date, (cumsum(CRSP_Monthly_B_Unique$Value_Weighted_Return[CRSP_Monthly_B_Unique$Volatility_Quintile == 5])), type = 'l', col = "red", lwd = 2.5)
legend("bottomleft", inset = c(0.02, 0.05), c("Low Volatility", "High Volatility"), lty = c(1, 1), lwd = c(2.5,2.5), cex = 0.8, col = c("dodgerblue4","red"))

#Output
Mean_Panel_B <- rbind(Mean_Quintile_B1, Mean_Quintile_B2, Mean_Quintile_B3, Mean_Quintile_B4, Mean_Quintile_B5)
Std_Dev_Panel_B <- rbind(Std_Dev_Quintile_B1, Std_Dev_Quintile_B2, Std_Dev_Quintile_B3, Std_Dev_Quintile_B4, Std_Dev_Quintile_B5)
Sharpe_Ratio_Panel_B <- rbind(SR_1, SR_2, SR_3, SR_4, SR_5)
CAPM_Alpha_Panel_B <- CRSP_Monthly_B_Unique$CAPM_Alpha[1:5]*100
CAPM_T_Test_Panel_B <- CRSP_Monthly_B_Unique$CAPM_Alpha_T_Test[1:5]
FF_Alpha_Panel_B <- CRSP_Monthly_B_Unique$FF_Alpha[1:5]*100
FF_T_Test_Panel_B <- CRSP_Monthly_B_Unique$FF_Alpha_T_Test[1:5]
FF_Beta_HML <- CRSP_Monthly_B_Unique$FF_Beta_HML[1:5]
FF_HML_T_Test <- CRSP_Monthly_B_Unique$FF_HML_T_Test[1:5]
FF_Beta_SMB <- CRSP_Monthly_B_Unique$FF_Beta_SMB[1:5]
FF_SMB_T_Test <- CRSP_Monthly_B_Unique$FF_SMB_T_Test[1:5]
FF_Beta_Market <- CRSP_Monthly_B_Unique$FF_Beta_Market[1:5]
FF_Market_T_Test <- CRSP_Monthly_B_Unique$FF_Market_T_Test[1:5]

Output_Panel_B <- cbind(Mean_Panel_B, Std_Dev_Panel_B, Sharpe_Ratio_Panel_B, cbind(CAPM_Alpha_Panel_B, CAPM_T_Test_Panel_B, FF_Alpha_Panel_B, FF_T_Test_Panel_B, FF_Beta_HML, FF_HML_T_Test, FF_Beta_SMB, FF_SMB_T_Test, FF_Beta_Market, FF_Market_T_Test))
Output_Panel_B <- rbind(Output_Panel_B, LS_Row[,1])
colnames(Output_Panel_B) <- c("Mean","Std Dev", "Sharpe Ratio", "CAPM Alpha", "CAPM Alpha T-Stat", "FF Alpha", "FF Alpha T-Stat", "FF Beta (HML)", "FF Beta (HML) T-Stat", "FF Beta (SMB)", "FF Beta (SMB) T-Stat", "FF Beta (Mkt)", "FF Beta (Mkt) T-Stat")
rownames(Output_Panel_B) <- c("1","2","3","4","5","Long Short")
B_Output <- round(Output_Panel_B,2)



#################################################################################
#################################################################################

####################  Out of Sample Analysis for Robustness  ####################
#############################  2003 - 2017  #####################################

#################################################################################
#################################################################################


#Read Required File
CRSP_Monthly_C <- fread("/Users/arpittanna/Desktop/MFE/Quarter 3/Quant Asset Management/Assignments/Project/C.csv", stringsAsFactors = FALSE, header = TRUE)
FF_Monthly <- fread("/Users/arpittanna/Desktop/MFE/Quarter 3/Quant Asset Management/Assignments/1/F-F_Research_Data_Factors.csv", stringsAsFactors = FALSE, skip = 3)

#Formatting the Date
CRSP_Monthly_C <- CRSP_Monthly_C[, date := as.Date(as.character(date), format = "%m/%d/%Y")]

#Keeping only Required Exchange Codes
CRSP_Monthly_C <- CRSP_Monthly_C[EXCHCD %in% c(1,2,3)]

#Setting Garbage Values to NA
CRSP_Monthly_C$RET[CRSP_Monthly_C$RET %in% c("C","B",-66,-77,-88,-99)] <- NA
CRSP_Monthly_C$DLRET[CRSP_Monthly_C$DLRET %in% c(-44,-55,-66,-77,-88,-99,"A","S","P","T")] <- NA

#Calculating Total Return
CRSP_Monthly_C <- CRSP_Monthly_C[, Stock_Return := ifelse(!is.na(as.numeric(CRSP_Monthly_C$RET)) & !is.na(as.numeric(CRSP_Monthly_C$DLRET)), (1+as.numeric(CRSP_Monthly_C$RET) * (1+as.numeric(CRSP_Monthly_C$DLRET))-1), ifelse(is.na(as.numeric(CRSP_Monthly_C$RET)), as.numeric(CRSP_Monthly_C$DLRET), as.numeric(CRSP_Monthly_C$RET)))]

#Calculating Market Cap
CRSP_Monthly_C <- CRSP_Monthly_C[, Stock_Market_Cap := abs(as.numeric(CRSP_Monthly_C$PRC)) * as.numeric(CRSP_Monthly_C$SHROUT)]
CRSP_Monthly_C <- CRSP_Monthly_C[, Stock_Market_Cap_Lag := shift(Stock_Market_Cap), by=c("PERMNO")]

#Isolating Month & Year
CRSP_Monthly_C <- CRSP_Monthly_C[,c('Month','Year') := .(month(date),year(date))]

#Calculating 5 Year Volatility from Monthly Data
CRSP_Monthly_C[, VOL5 := (rollapply(shift(RET), width = 60, fill = NA, align = "right", sd, partial = TRUE)), by = .(PERMNO)]
CRSP_Monthly_C <- setDT(CRSP_Monthly_C)[, if(.N >= 61) .SD, by = PERMNO]
CRSP_Monthly_C <- CRSP_Monthly_C %>% group_by(PERMNO) %>% slice(-1:-60)
CRSP_Monthly_C <- as.data.table(CRSP_Monthly_C)

#Calculating Quintile for Volatility
GetPortNums_Volatility <- function(x,y)
{
  Quintile <- c(0, quantile(y, probs = seq(0,1,0.2), na.rm = TRUE)[2:5], 1)
  return(as.integer(cut(y, Quintile, na.rm = TRUE), include.lowest = TRUE))
}

#Calculating Lag Volatility
CRSP_Monthly_C <- CRSP_Monthly_C[, Volatility_Lag := shift(VOL5), by=c("PERMNO")]

#Calculating the Quintiles
CRSP_Monthly_C <- CRSP_Monthly_C[, Volatility_Quintile := (GetPortNums_Volatility(EXCHCD, Volatility_Lag)), by=.(Year, Month)]

#Calculating Value Weighted Return
CRSP_Monthly_C[, Value_Weighted_Return := sum(Stock_Market_Cap_Lag*as.numeric(RET), na.rm = TRUE)/sum(Stock_Market_Cap_Lag, na.rm = TRUE), by=c("Year", "Month", "Volatility_Quintile")]

#Removing all NAs
CRSP_Monthly_C <- CRSP_Monthly_C[!is.na(Stock_Market_Cap_Lag) & !is.na(Value_Weighted_Return) & !is.na(Volatility_Quintile) & !is.na(RET)]

#Order the Data Table by Year, Month, and Volatility Quintile
CRSP_Monthly_C <- CRSP_Monthly_C[order(Year, Month, Volatility_Quintile)]

#Removing Duplicate Value Weighted Returns
CRSP_Monthly_C_Unique <- CRSP_Monthly_C[!duplicated(Value_Weighted_Return)]

#Calculating Portfolio Mean
Mean_Quintile_C1 <- mean(CRSP_Monthly_C_Unique$Value_Weighted_Return[CRSP_Monthly_C_Unique$Volatility_Quintile == 1])*100
Mean_Quintile_C2 <- mean(CRSP_Monthly_C_Unique$Value_Weighted_Return[CRSP_Monthly_C_Unique$Volatility_Quintile == 2])*100
Mean_Quintile_C3 <- mean(CRSP_Monthly_C_Unique$Value_Weighted_Return[CRSP_Monthly_C_Unique$Volatility_Quintile == 3])*100
Mean_Quintile_C4 <- mean(CRSP_Monthly_C_Unique$Value_Weighted_Return[CRSP_Monthly_C_Unique$Volatility_Quintile == 4])*100
Mean_Quintile_C5 <- mean(CRSP_Monthly_C_Unique$Value_Weighted_Return[CRSP_Monthly_C_Unique$Volatility_Quintile == 5])*100

#Calculating Portfolio Standard Deviation
Std_Dev_Quintile_C1 <- sd(CRSP_Monthly_C_Unique$Value_Weighted_Return[CRSP_Monthly_C_Unique$Volatility_Quintile == 1])*100
Std_Dev_Quintile_C2 <- sd(CRSP_Monthly_C_Unique$Value_Weighted_Return[CRSP_Monthly_C_Unique$Volatility_Quintile == 2])*100
Std_Dev_Quintile_C3 <- sd(CRSP_Monthly_C_Unique$Value_Weighted_Return[CRSP_Monthly_C_Unique$Volatility_Quintile == 3])*100
Std_Dev_Quintile_C4 <- sd(CRSP_Monthly_C_Unique$Value_Weighted_Return[CRSP_Monthly_C_Unique$Volatility_Quintile == 4])*100
Std_Dev_Quintile_C5 <- sd(CRSP_Monthly_C_Unique$Value_Weighted_Return[CRSP_Monthly_C_Unique$Volatility_Quintile == 5])*100

#Calculating Portfolio Sharpe Ratio
SR_1 <- mean(CRSP_Monthly_C_Unique$Value_Weighted_Return[CRSP_Monthly_C_Unique$Volatility_Quintile == 1] - FF_Monthly$RF[1040:1098]/100)/sd(CRSP_Monthly_C_Unique$Value_Weighted_Return[CRSP_Monthly_C_Unique$Volatility_Quintile == 1] - FF_Monthly$RF[1040:1098]/100)
SR_2 <- mean(CRSP_Monthly_C_Unique$Value_Weighted_Return[CRSP_Monthly_C_Unique$Volatility_Quintile == 2] - FF_Monthly$RF[1040:1098]/100)/sd(CRSP_Monthly_C_Unique$Value_Weighted_Return[CRSP_Monthly_C_Unique$Volatility_Quintile == 2] - FF_Monthly$RF[1040:1098]/100)
SR_3 <- mean(CRSP_Monthly_C_Unique$Value_Weighted_Return[CRSP_Monthly_C_Unique$Volatility_Quintile == 3] - FF_Monthly$RF[1040:1098]/100)/sd(CRSP_Monthly_C_Unique$Value_Weighted_Return[CRSP_Monthly_C_Unique$Volatility_Quintile == 3] - FF_Monthly$RF[1040:1098]/100)
SR_4 <- mean(CRSP_Monthly_C_Unique$Value_Weighted_Return[CRSP_Monthly_C_Unique$Volatility_Quintile == 4] - FF_Monthly$RF[1040:1098]/100)/sd(CRSP_Monthly_C_Unique$Value_Weighted_Return[CRSP_Monthly_C_Unique$Volatility_Quintile == 4] - FF_Monthly$RF[1040:1098]/100)
SR_5 <- mean(CRSP_Monthly_C_Unique$Value_Weighted_Return[CRSP_Monthly_C_Unique$Volatility_Quintile == 5] - FF_Monthly$RF[1040:1098]/100)/sd(CRSP_Monthly_C_Unique$Value_Weighted_Return[CRSP_Monthly_C_Unique$Volatility_Quintile == 5] - FF_Monthly$RF[1040:1098]/100)

#CAPM Alpha and T-Stat
CRSP_Monthly_C_Unique[, Market_Excess_Return := FF_Monthly$`Mkt-RF`[1040:1098]/100, by=.(Volatility_Quintile)]
CRSP_Monthly_C_Unique[, Value_Weighted_Excess_Return := Value_Weighted_Return - FF_Monthly$RF[1040:1098]/100, by=.(Volatility_Quintile)]
CRSP_Monthly_C_Unique[, CAPM_Alpha := as.list(coef(lm(Value_Weighted_Excess_Return ~ Market_Excess_Return))), by=.(Volatility_Quintile)]
CRSP_Monthly_C_Unique[, CAPM_Alpha_T_Test := coeftest((lm(Value_Weighted_Excess_Return ~ Market_Excess_Return)), vcov = NeweyWest((lm(Value_Weighted_Excess_Return ~ Market_Excess_Return)), lag = 1, prewhite = FALSE))[1,3], by=.(Volatility_Quintile)]

#FF Alpha and T-Stat
CRSP_Monthly_C_Unique[, HML := FF_Monthly$HML[1040:1098]/100, by=.(Volatility_Quintile)]
CRSP_Monthly_C_Unique[, SMB := FF_Monthly$SMB[1040:1098]/100, by=.(Volatility_Quintile)]
CRSP_Monthly_C_Unique[, FF_Alpha := coeftest((lm(Value_Weighted_Excess_Return ~ (HML + SMB + Market_Excess_Return))), vcov = NeweyWest((lm(Value_Weighted_Excess_Return ~ (HML + SMB + Market_Excess_Return))), lag = 1, prewhite = FALSE))[1,1], by=.(Volatility_Quintile)]
CRSP_Monthly_C_Unique[, FF_Alpha_T_Test := coeftest((lm(Value_Weighted_Excess_Return ~ (HML + SMB + Market_Excess_Return))), vcov = NeweyWest((lm(Value_Weighted_Excess_Return ~ (HML + SMB + Market_Excess_Return))), lag = 1, prewhite = FALSE))[1,3], by=.(Volatility_Quintile)]
CRSP_Monthly_C_Unique[, FF_Beta_HML := coeftest((lm(Value_Weighted_Excess_Return ~ (HML + SMB + Market_Excess_Return))), vcov = NeweyWest((lm(Value_Weighted_Excess_Return ~ (HML + SMB + Market_Excess_Return))), lag = 1, prewhite = FALSE))[2,1], by=.(Volatility_Quintile)]
CRSP_Monthly_C_Unique[, FF_Beta_SMB := coeftest((lm(Value_Weighted_Excess_Return ~ (HML + SMB + Market_Excess_Return))), vcov = NeweyWest((lm(Value_Weighted_Excess_Return ~ (HML + SMB + Market_Excess_Return))), lag = 1, prewhite = FALSE))[3,1], by=.(Volatility_Quintile)]
CRSP_Monthly_C_Unique[, FF_Beta_Market := coeftest((lm(Value_Weighted_Excess_Return ~ (HML + SMB + Market_Excess_Return))), vcov = NeweyWest((lm(Value_Weighted_Excess_Return ~ (HML + SMB + Market_Excess_Return))), lag = 1, prewhite = FALSE))[4,1], by=.(Volatility_Quintile)]
CRSP_Monthly_C_Unique[, FF_HML_T_Test := coeftest((lm(Value_Weighted_Excess_Return ~ (HML + SMB + Market_Excess_Return))), vcov = NeweyWest((lm(Value_Weighted_Excess_Return ~ (HML + SMB + Market_Excess_Return))), lag = 1, prewhite = FALSE))[2,3], by=.(Volatility_Quintile)]
CRSP_Monthly_C_Unique[, FF_SMB_T_Test := coeftest((lm(Value_Weighted_Excess_Return ~ (HML + SMB + Market_Excess_Return))), vcov = NeweyWest((lm(Value_Weighted_Excess_Return ~ (HML + SMB + Market_Excess_Return))), lag = 1, prewhite = FALSE))[3,3], by=.(Volatility_Quintile)]
CRSP_Monthly_C_Unique[, FF_Market_T_Test := coeftest((lm(Value_Weighted_Excess_Return ~ (HML + SMB + Market_Excess_Return))), vcov = NeweyWest((lm(Value_Weighted_Excess_Return ~ (HML + SMB + Market_Excess_Return))), lag = 1, prewhite = FALSE))[4,3], by=.(Volatility_Quintile)]

#Long Short
Mean_Long_Short_C <- Mean_Quintile_C1 - Mean_Quintile_C5
Std_Dev_Long_Short_C <- sd(CRSP_Monthly_C_Unique$Value_Weighted_Return[CRSP_Monthly_C_Unique$Volatility_Quintile == 1] - CRSP_Monthly_C_Unique$Value_Weighted_Return[CRSP_Monthly_C_Unique$Volatility_Quintile == 5])*100
SR_Long_Short <- mean(((CRSP_Monthly_C_Unique$Value_Weighted_Return[CRSP_Monthly_C_Unique$Volatility_Quintile == 1] - FF_Monthly$RF[1040:1098]/100) - (CRSP_Monthly_C_Unique$Value_Weighted_Return[CRSP_Monthly_C_Unique$Volatility_Quintile == 5] - FF_Monthly$RF[1040:1098]/100))/sd(((CRSP_Monthly_C_Unique$Value_Weighted_Return[CRSP_Monthly_C_Unique$Volatility_Quintile == 1] - FF_Monthly$RF[1040:1098]/100) - (CRSP_Monthly_C_Unique$Value_Weighted_Return[CRSP_Monthly_C_Unique$Volatility_Quintile == 5] - FF_Monthly$RF[1040:1098]/100))))

ABC <- FF_Monthly$`Mkt-RF`[1040:1098]/100
XYZ <- (CRSP_Monthly_C_Unique$Value_Weighted_Return[CRSP_Monthly_C_Unique$Volatility_Quintile == 1] - CRSP_Monthly_C_Unique$Value_Weighted_Return[CRSP_Monthly_C_Unique$Volatility_Quintile == 5])

CAPM_Alpha_LS_C <- as.numeric(coef(lm(XYZ ~ ABC))[1])*100
CAPM_Alpha_T_Stat_LS_C <- coeftest((lm(XYZ ~ ABC)), vcov = NeweyWest((lm(XYZ ~ ABC)), lag = 1, prewhite = FALSE))[1,3]

FF_Alpha_LS <- coeftest((lm(XYZ ~ (CRSP_Monthly_C_Unique$HML[CRSP_Monthly_C_Unique$Volatility_Quintile == 1] + CRSP_Monthly_C_Unique$SMB[CRSP_Monthly_C_Unique$Volatility_Quintile == 1] + ABC))), vcov = NeweyWest((lm(XYZ ~ (CRSP_Monthly_C_Unique$HML[CRSP_Monthly_C_Unique$Volatility_Quintile == 1] + CRSP_Monthly_C_Unique$SMB[CRSP_Monthly_C_Unique$Volatility_Quintile == 1] + ABC))), lag = 1, prewhite = FALSE))[1,1]*100
FF_Alpha_T_Test_LS <- coeftest((lm(XYZ ~ (CRSP_Monthly_C_Unique$HML[CRSP_Monthly_C_Unique$Volatility_Quintile == 1] + CRSP_Monthly_C_Unique$SMB[CRSP_Monthly_C_Unique$Volatility_Quintile == 1] + ABC))), vcov = NeweyWest((lm(XYZ ~ (CRSP_Monthly_C_Unique$HML[CRSP_Monthly_C_Unique$Volatility_Quintile == 1] + CRSP_Monthly_C_Unique$SMB[CRSP_Monthly_C_Unique$Volatility_Quintile == 1] + ABC))), lag = 1, prewhite = FALSE))[1,3]
FF_Beta_HML_LS <- coeftest((lm(XYZ ~ (CRSP_Monthly_C_Unique$HML[CRSP_Monthly_C_Unique$Volatility_Quintile == 1] + CRSP_Monthly_C_Unique$SMB[CRSP_Monthly_C_Unique$Volatility_Quintile == 1] + ABC))), vcov = NeweyWest((lm(XYZ ~ (CRSP_Monthly_C_Unique$HML[CRSP_Monthly_C_Unique$Volatility_Quintile == 1] + CRSP_Monthly_C_Unique$SMB[CRSP_Monthly_C_Unique$Volatility_Quintile == 1] + ABC))), lag = 1, prewhite = FALSE))[2,1]
FF_Beta_SMB_LS <- coeftest((lm(XYZ ~ (CRSP_Monthly_C_Unique$HML[CRSP_Monthly_C_Unique$Volatility_Quintile == 1] + CRSP_Monthly_C_Unique$SMB[CRSP_Monthly_C_Unique$Volatility_Quintile == 1] + ABC))), vcov = NeweyWest((lm(XYZ ~ (CRSP_Monthly_C_Unique$HML[CRSP_Monthly_C_Unique$Volatility_Quintile == 1] + CRSP_Monthly_C_Unique$SMB[CRSP_Monthly_C_Unique$Volatility_Quintile == 1] + ABC))), lag = 1, prewhite = FALSE))[3,1]
FF_Beta_Market_LS <- coeftest((lm(XYZ ~ (CRSP_Monthly_C_Unique$HML[CRSP_Monthly_C_Unique$Volatility_Quintile == 1] + CRSP_Monthly_C_Unique$SMB[CRSP_Monthly_C_Unique$Volatility_Quintile == 1] + ABC))), vcov = NeweyWest((lm(XYZ ~ (CRSP_Monthly_C_Unique$HML[CRSP_Monthly_C_Unique$Volatility_Quintile == 1] + CRSP_Monthly_C_Unique$SMB[CRSP_Monthly_C_Unique$Volatility_Quintile == 1] + ABC))), lag = 1, prewhite = FALSE))[4,1]
FF_HML_T_Test_LS <- coeftest((lm(XYZ ~ (CRSP_Monthly_C_Unique$HML[CRSP_Monthly_C_Unique$Volatility_Quintile == 1] + CRSP_Monthly_C_Unique$SMB[CRSP_Monthly_C_Unique$Volatility_Quintile == 1] + ABC))), vcov = NeweyWest((lm(XYZ ~ (CRSP_Monthly_C_Unique$HML[CRSP_Monthly_C_Unique$Volatility_Quintile == 1] + CRSP_Monthly_C_Unique$SMB[CRSP_Monthly_C_Unique$Volatility_Quintile == 1] + ABC))), lag = 1, prewhite = FALSE))[2,3]
FF_SMB_T_Test_LS <- coeftest((lm(XYZ ~ (CRSP_Monthly_C_Unique$HML[CRSP_Monthly_C_Unique$Volatility_Quintile == 1] + CRSP_Monthly_C_Unique$SMB[CRSP_Monthly_C_Unique$Volatility_Quintile == 1] + ABC))), vcov = NeweyWest((lm(XYZ ~ (CRSP_Monthly_C_Unique$HML[CRSP_Monthly_C_Unique$Volatility_Quintile == 1] + CRSP_Monthly_C_Unique$SMB[CRSP_Monthly_C_Unique$Volatility_Quintile == 1] + ABC))), lag = 1, prewhite = FALSE))[3,3]
FF_Market_T_Test_LS <- coeftest((lm(XYZ ~ (CRSP_Monthly_C_Unique$HML[CRSP_Monthly_C_Unique$Volatility_Quintile == 1] + CRSP_Monthly_C_Unique$SMB[CRSP_Monthly_C_Unique$Volatility_Quintile == 1] + ABC))), vcov = NeweyWest((lm(XYZ ~ (CRSP_Monthly_C_Unique$HML[CRSP_Monthly_C_Unique$Volatility_Quintile == 1] + CRSP_Monthly_C_Unique$SMB[CRSP_Monthly_C_Unique$Volatility_Quintile == 1] + ABC))), lag = 1, prewhite = FALSE))[4,3]

LS_Row <- rbind(Mean_Long_Short_C, Std_Dev_Long_Short_C, SR_Long_Short, CAPM_Alpha_LS_C, CAPM_Alpha_T_Stat_LS_C, FF_Alpha_LS, FF_Alpha_T_Test_LS, FF_Beta_HML_LS, FF_HML_T_Test_LS, FF_Beta_SMB_LS, FF_SMB_T_Test_LS, FF_Beta_Market_LS, FF_Market_T_Test_LS)

#Plot
Date <- as.Date(unique(CRSP_Monthly_C_Unique$date))
plot(Date, cumsum(CRSP_Monthly_C_Unique$Value_Weighted_Return[CRSP_Monthly_C_Unique$Volatility_Quintile == 1]), type = 'l', col = "dodgerblue4", lwd = 2.5, main = "Low Volatility vs. High Volatility (2013-2017)", xlab = "Time", ylab = "Aggregate Returns", ylim = c(-0.1,0.6))
lines(Date, (cumsum(CRSP_Monthly_C_Unique$Value_Weighted_Return[CRSP_Monthly_C_Unique$Volatility_Quintile == 5])), type = 'l', col = "red", lwd = 2.5)
legend("topleft", inset = c(0.02, 0.06), c("Low Volatility", "High Volatility"), lty = c(1, 1), lwd = c(2.5,2.5), cex = 0.8, col = c("dodgerblue4","red"))

#Output
Mean_Panel_C <- rbind(Mean_Quintile_C1, Mean_Quintile_C2, Mean_Quintile_C3, Mean_Quintile_C4, Mean_Quintile_C5)
Std_Dev_Panel_C <- rbind(Std_Dev_Quintile_C1, Std_Dev_Quintile_C2, Std_Dev_Quintile_C3, Std_Dev_Quintile_C4, Std_Dev_Quintile_C5)
Sharpe_Ratio_Panel_C <- rbind(SR_1, SR_2, SR_3, SR_4, SR_5)
CAPM_Alpha_Panel_C <- CRSP_Monthly_C_Unique$CAPM_Alpha[1:5]*100
CAPM_T_Test_Panel_C <- CRSP_Monthly_C_Unique$CAPM_Alpha_T_Test[1:5]
FF_Alpha_Panel_C <- CRSP_Monthly_C_Unique$FF_Alpha[1:5]*100
FF_T_Test_Panel_C <- CRSP_Monthly_C_Unique$FF_Alpha_T_Test[1:5]
FF_Beta_HML <- CRSP_Monthly_C_Unique$FF_Beta_HML[1:5]
FF_HML_T_Test <- CRSP_Monthly_C_Unique$FF_HML_T_Test[1:5]
FF_Beta_SMB <- CRSP_Monthly_C_Unique$FF_Beta_SMB[1:5]
FF_SMB_T_Test <- CRSP_Monthly_C_Unique$FF_SMB_T_Test[1:5]
FF_Beta_Market <- CRSP_Monthly_C_Unique$FF_Beta_Market[1:5]
FF_Market_T_Test <- CRSP_Monthly_C_Unique$FF_Market_T_Test[1:5]

Output_Panel_C <- cbind(Mean_Panel_C, Std_Dev_Panel_C, Sharpe_Ratio_Panel_C, cbind(CAPM_Alpha_Panel_C, CAPM_T_Test_Panel_C, FF_Alpha_Panel_C, FF_T_Test_Panel_C, FF_Beta_HML, FF_HML_T_Test, FF_Beta_SMB, FF_SMB_T_Test, FF_Beta_Market, FF_Market_T_Test))
Output_Panel_C <- rbind(Output_Panel_C, LS_Row[,1])
colnames(Output_Panel_C) <- c("Mean","Std Dev", "Sharpe Ratio", "CAPM Alpha", "CAPM Alpha T-Stat", "FF Alpha", "FF Alpha T-Stat", "FF Beta (HML)", "FF Beta (HML) T-Stat", "FF Beta (SMB)", "FF Beta (SMB) T-Stat", "FF Beta (Mkt)", "FF Beta (Mkt) T-Stat")
rownames(Output_Panel_C) <- c("1","2","3","4","5","Long Short")
C_Output <- round(Output_Panel_C,2)
